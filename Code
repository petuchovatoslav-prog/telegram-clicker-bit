import telebot
import random
import os
import time
from threading import Thread

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
TOKEN = os.environ.get('BOT_TOKEN')

bot = telebot.TeleBot(TOKEN)

# Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸)
users = {}

# ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
def main_keyboard():
    keyboard = telebot.types.InlineKeyboardMarkup(row_width=2)
    btn1 = telebot.types.InlineKeyboardButton('ğŸª™ ĞšĞ›Ğ˜ĞšĞĞ£Ğ¢Ğ¬', callback_data='click')
    btn2 = telebot.types.InlineKeyboardButton('â¬†ï¸ ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”', callback_data='upgrade')
    btn3 = telebot.types.InlineKeyboardButton('ğŸª™ ĞœĞĞĞ•Ğ¢ĞšĞ', callback_data='coin_menu')
    btn4 = telebot.types.InlineKeyboardButton('ğŸ ĞŸĞ ĞĞœĞĞšĞĞ”', callback_data='promo')
    btn5 = telebot.types.InlineKeyboardButton('ğŸ“Š ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬', callback_data='profile')
    keyboard.add(btn1, btn2, btn3, btn4, btn5)
    return keyboard

def coin_keyboard():
    keyboard = telebot.types.InlineKeyboardMarkup(row_width=2)
    btn1 = telebot.types.InlineKeyboardButton('ğŸ¦… ĞĞ ĞĞ›', callback_data='heads')
    btn2 = telebot.types.InlineKeyboardButton('ğŸ’² Ğ Ğ•Ğ¨ĞšĞ', callback_data='tails')
    btn3 = telebot.types.InlineKeyboardButton('ğŸ”™ ĞĞĞ—ĞĞ”', callback_data='back')
    keyboard.add(btn1, btn2, btn3)
    return keyboard

def back_keyboard():
    keyboard = telebot.types.InlineKeyboardMarkup()
    btn = telebot.types.InlineKeyboardButton('ğŸ”™ ĞĞĞ—ĞĞ”', callback_data='back')
    keyboard.add(btn)
    return keyboard

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
def get_user(user_id):
    if user_id not in users:
        users[user_id] = {
            'balance': 100,
            'power': 1,
            'clicks': 0,
            'level': 0,
            'total_clicks': 0,
            'promos': [],
            'wins': 0,
            'losses': 0
        }
    return users[user_id]

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    user = get_user(user_id)
    
    text = (f"ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {message.from_user.first_name}!\n\n"
            f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']} Ğ¼Ğ¾Ğ½ĞµÑ‚\n"
            f"âš¡ Ğ¡Ğ¸Ğ»Ğ° ĞºĞ»Ğ¸ĞºĞ°: {user['power']}\n"
            f"ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: {user['clicks']}/100\n\n"
            f"ğŸ‘‡ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:")
    
    bot.send_message(message.chat.id, text, reply_markup=main_keyboard())

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
@bot.callback_query_handler(func=lambda call: True)
def callback_handler(call):
    user_id = call.from_user.id
    user = get_user(user_id)
    
    # ĞšĞ›Ğ˜Ğš
    if call.data == 'click':
        user['balance'] += user['power']
        user['clicks'] += 1
        user['total_clicks'] += 1
        
        text = (f"âœ… +{user['power']} Ğ¼Ğ¾Ğ½ĞµÑ‚!\n\n"
                f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}\n"
                f"âš¡ Ğ¡Ğ¸Ğ»Ğ°: {user['power']}\n"
                f"ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: {user['clicks']}/100")
        
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, 
                            reply_markup=main_keyboard())
    
    # ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”
    elif call.data == 'upgrade':
        if user['clicks'] >= 100:
            user['clicks'] = 0
            user['level'] += 1
            
            # Ğ¡Ğ¸Ğ»Ğ° ĞºĞ»Ğ¸ĞºĞ° Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ Ğ´Ğ¾ 100Ğº
            if user['level'] == 1: user['power'] = 2
            elif user['level'] == 2: user['power'] = 5
            elif user['level'] == 3: user['power'] = 10
            elif user['level'] == 4: user['power'] = 25
            elif user['level'] == 5: user['power'] = 50
            elif user['level'] == 6: user['power'] = 100
            elif user['level'] == 7: user['power'] = 250
            elif user['level'] == 8: user['power'] = 500
            elif user['level'] == 9: user['power'] = 1000
            elif user['level'] == 10: user['power'] = 2500
            elif user['level'] == 11: user['power'] = 5000
            elif user['level'] == 12: user['power'] = 10000
            elif user['level'] == 13: user['power'] = 25000
            elif user['level'] == 14: user['power'] = 50000
            elif user['level'] >= 15: user['power'] = 100000
            
            text = (f"â¬†ï¸ ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”!\n\n"
                    f"ğŸ”¨ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: {user['level']}\n"
                    f"âš¡ Ğ¡Ğ¸Ğ»Ğ°: {user['power']}")
            
            bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                                reply_markup=main_keyboard())
        else:
            bot.answer_callback_query(call.id, f"âŒ ĞÑƒĞ¶Ğ½Ğ¾ ĞµÑ‰Ñ‘ {100 - user['clicks']} ĞºĞ»Ğ¸ĞºĞ¾Ğ²!", 
                                     show_alert=True)
    
    # ĞœĞ•ĞĞ® ĞœĞĞĞ•Ğ¢ĞšĞ˜
    elif call.data == 'coin_menu':
        text = (f"ğŸª™ ĞœĞĞĞ•Ğ¢ĞšĞ 50/50\n\n"
                f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}\n"
                f"ğŸ“Š Ğ¡Ñ‡Ñ‘Ñ‚: {user['wins']}âœ… / {user['losses']}âŒ\n\n"
                f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñƒ:")
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                            reply_markup=coin_keyboard())
    
    # Ğ’Ğ«Ğ‘ĞĞ  ĞĞ ĞĞ›/Ğ Ğ•Ğ¨ĞšĞ
    elif call.data in ['heads', 'tails']:
        side = call.data
        text = (f"ğŸ’° Ğ¢Ğ²Ğ¾Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€: {'ĞĞ ĞĞ›' if side == 'heads' else 'Ğ Ğ•Ğ¨ĞšĞ'}\n"
                f"ğŸ’µ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}\n\n"
                f"âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ÑÑƒĞ¼Ğ¼Ñƒ ÑÑ‚Ğ°Ğ²ĞºĞ¸:")
        
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                            reply_markup=back_keyboard())
        bot.register_next_step_handler(call.message, process_coin_bet, side)
    
    # ĞŸĞ ĞĞœĞĞšĞĞ”
    elif call.data == 'promo':
        text = ("ğŸ Ğ’Ğ’Ğ•Ğ”Ğ˜ ĞŸĞ ĞĞœĞĞšĞĞ”\n\n"
                "ğŸ“ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ĞºĞ¾Ğ´ Ğ² Ñ‡Ğ°Ñ‚\n"
                "ğŸ”¥ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ´Ñ‹:\n"
                "â€¢ test - 1000 Ğ¼Ğ¾Ğ½ĞµÑ‚\n"
                "â€¢ start - 500 Ğ¼Ğ¾Ğ½ĞµÑ‚\n"
                "â€¢ bonus - 777 Ğ¼Ğ¾Ğ½ĞµÑ‚")
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                            reply_markup=back_keyboard())
        bot.register_next_step_handler(call.message, process_promo)
    
    # ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬
    elif call.data == 'profile':
        text = (f"ğŸ“Š Ğ¢Ğ’ĞĞ™ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬\n\n"
                f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}\n"
                f"âš¡ Ğ¡Ğ¸Ğ»Ğ° ĞºĞ»Ğ¸ĞºĞ°: {user['power']}\n"
                f"ğŸ”¨ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: {user['level']}\n"
                f"ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: {user['clicks']}/100\n"
                f"ğŸ“ˆ Ğ’ÑĞµĞ³Ğ¾ ĞºĞ»Ğ¸ĞºĞ¾Ğ²: {user['total_clicks']}\n"
                f"ğŸ² ĞœĞ¾Ğ½ĞµÑ‚ĞºĞ°: {user['wins']}âœ… / {user['losses']}âŒ")
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                            reply_markup=main_keyboard())
    
    # ĞĞĞ—ĞĞ”
    elif call.data == 'back':
        user = get_user(user_id)
        text = (f"ğŸ‘‹ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ\n\n"
                f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}\n"
                f"âš¡ Ğ¡Ğ¸Ğ»Ğ° ĞºĞ»Ğ¸ĞºĞ°: {user['power']}")
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id,
                            reply_markup=main_keyboard())

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ğ°Ğ²ĞºĞ¸
def process_coin_bet(message, side):
    user_id = message.from_user.id
    user = get_user(user_id)
    
    try:
        bet = int(message.text)
        if bet <= 0 or bet > user['balance']:
            bot.send_message(message.chat.id, "âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°!", 
                           reply_markup=main_keyboard())
            return
        
        user['balance'] -= bet
        result = random.choice(['heads', 'tails'])
        win = result == side
        
        if win:
            user['balance'] += bet * 2
            user['wins'] += 1
            text = (f"ğŸ‰ ĞŸĞĞ‘Ğ•Ğ”Ğ!\n\n"
                    f"ğŸª™ Ğ’Ñ‹Ğ¿Ğ°Ğ»Ğ¾: {'ĞĞ ĞĞ›' if result == 'heads' else 'Ğ Ğ•Ğ¨ĞšĞ'}\n"
                    f"ğŸ’° Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ: {bet * 2}\n"
                    f"ğŸ’µ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}")
        else:
            user['losses'] += 1
            text = (f"ğŸ˜ ĞŸĞ ĞĞ˜Ğ“Ğ Ğ«Ğ¨\n\n"
                    f"ğŸª™ Ğ’Ñ‹Ğ¿Ğ°Ğ»Ğ¾: {'ĞĞ ĞĞ›' if result == 'heads' else 'Ğ Ğ•Ğ¨ĞšĞ'}\n"
                    f"ğŸ’¸ ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾: {bet}\n"
                    f"ğŸ’µ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}")
        
        bot.send_message(message.chat.id, text, reply_markup=main_keyboard())
        
    except ValueError:
        bot.send_message(message.chat.id, "âŒ Ğ’Ğ²ĞµĞ´Ğ¸ Ñ‡Ğ¸ÑĞ»Ğ¾!", reply_markup=main_keyboard())

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
def process_promo(message):
    user_id = message.from_user.id
    user = get_user(user_id)
    code = message.text.lower()
    
    promos = {
        'test': 1000,
        'start': 500,
        'bonus': 777
    }
    
    if code in promos and code not in user['promos']:
        bonus = promos[code]
        user['balance'] += bonus
        user['promos'].append(code)
        text = f"âœ… ĞŸĞ ĞĞœĞĞšĞĞ” +{bonus}!\nğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {user['balance']}"
    elif code in user['promos']:
        text = "âŒ Ğ¢Ñ‹ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ» ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ´!"
    else:
        text = "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´!"
    
    bot.send_message(message.chat.id, text, reply_markup=main_keyboard())

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
@bot.message_handler(commands=['ping'])
def ping(message):
    bot.reply_to(message, "ğŸ“ Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!")

print("âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
bot.infinity_polling()
